{% extends 'base.html' %}
{% block title %}View Parking Spots{% endblock %}
{% block content %}

<style>
  .spot-label { cursor: pointer; position: relative; }
  .floating-form {
    display: none;
    position: absolute;
    top: -120px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    background: #fff;
    border: 1px solid #333;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    padding: 10px 12px;
    min-width: 140px;
  }
  input[type="radio"].spot-toggle:checked + label .floating-form {
    display: block;
  }
  .spot-label .rounded {
    transition: box-shadow 0.2s;
  }
  input[type="radio"].spot-toggle:checked + label .rounded {
    box-shadow: 0 0 0 3px #0d6efd;
  }
</style>

<div class="container py-5">
  <h2 class="mb-4 text-center">Parking Spot Grids</h2>

  <!-- City Filter Dropdown -->
  <form method="GET" action="{{ url_for('parking_spots') }}" class="mb-4 text-center">
    <label for="city_id"><strong>Select City:</strong></label>
    <select name="city_id" id="city_id" onchange="this.form.submit()" class="form-select d-inline-block w-auto ms-2">
      <option value="">-- All Cities --</option>
      {% for city in cities %}
        <option value="{{ city.id }}" {% if city.id|string == selected_city_id %}selected{% endif %}>
          {{ city.name }}
        </option>
      {% endfor %}
    </select>
  </form>

  {% if lots %}
    {% for lot_id, lot in lots.items() %}
      <div class="mb-5">
        <h5 class="mb-2 text-center">{{ lot.prime_location_name }} ({{ lot.maximum_number_of_spots }} spots)</h5>
        <div class="w-100 position-relative">
          {% set lot_spots = spots|selectattr('lot_id', 'equalto', lot_id)|list %}
          {% set columns = 8 %}
          <!-- Dummy radio to close all -->
          <input type="radio" name="open_spot_{{ lot_id }}" id="close_spot_{{ lot_id }}" class="spot-toggle d-none" checked>
          {% for i in range(0, lot_spots|length, columns) %}
            <div class="d-flex justify-content-center mb-2">
              {% for spot in lot_spots[i:i+columns] %}
                {% set radio_id = 'spot_' ~ lot_id ~ '_' ~ spot.id %}
                <input type="radio" name="open_spot_{{ lot_id }}" id="{{ radio_id }}" class="spot-toggle d-none">
                <label for="{{ radio_id }}" class="spot-label d-flex flex-column align-items-center mx-1 p-0" style="width: 60px;">
                  <div class="rounded mb-1"
                       style="width: 38px; height: 38px; background: {% if spot.status == 'A' %}#198754{% else %}#dc3545{% endif %}; border: 2px solid #333; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold;">
                    {{ spot.id }}
                  </div>
                  <small class="text-muted" style="font-size: 0.75rem;">{{ 'A' if spot.status == 'A' else 'O' }}</small>
                  <div class="floating-form">
                    <form method="POST" action="/update_parking_spot/{{ spot.id }}">
                      <div class="mb-2">
                        <select name="status" class="form-select form-select-sm">
                          <option value="A" {% if spot.status == 'A' %}selected{% endif %}>Available</option>
                          <option value="O" {% if spot.status == 'O' %}selected{% endif %}>Occupied</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <input type="text" name="vehicle_number" class="form-control form-control-sm" value="{{ spot.vehicle_number or '' }}" {% if spot.status == 'O' %}readonly{% endif %} placeholder="Vehicle #">
                      </div>
                      <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-sm btn-primary">Update</button>
                        <label for="close_spot_{{ lot_id }}" class="btn btn-sm btn-outline-secondary ms-2" style="font-size:0.8rem;">Close</label>
                      </div>
                    </form>
                  </div>
                </label>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info text-center">No parking lots found for the selected city.</div>
  {% endif %}

  <div class="text-center">
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">Back to Admin Dashboard</a>
  </div>
</div>

{% endblock %}
